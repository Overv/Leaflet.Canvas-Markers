"use strict";!function(i,t){"function"==typeof define&&define.amd?define(["leaflet"],i):"object"==typeof exports&&(module.exports=i(require("leaflet"))),void 0!==t&&t.L&&(t.L.CanvasIconLayer=i(L))}(function(i){var t=(i.Layer?i.Layer:i.Class).extend({initialize:function(t){this.imageCache={},this._zIndex=0,i.setOptions(this,t)},setOptions:function(t){return i.setOptions(this,t),this._canvas&&this._updateOptions(),this.redraw()},redraw:function(){this._redraw(!0)},addMarker:function(t){i.Util.stamp(t),this._markers||(this._markers={}),this._markers[t._leaflet_id]=t;t.on("move",this._scheduleRedraw,this),this._drawMarker(t)},_scheduleRedraw:function(){if(!this._frame){var t=this;this._frame=i.Util.requestAnimFrame(function(){t._redraw(!0)})}},addLayer:function(i){"markerPane"==i.options.pane&&i.options.icon?this.addMarker(i):console.error("Layer isn't a marker")},removeLayer:function(i){this.removeMarker(i,!0)},removeMarker:function(i,t){delete this._markers[i._leaflet_id],t&&this._redraw(!0)},onAdd:function(i){this._map=i,this._onClickListeners=[],this._canvas||this._initCanvas(),this.options.pane?this.getPane().appendChild(this._canvas):i._panes.overlayPane.appendChild(this._canvas),i.on("move",this._reset,this),i.on("zoom",this._reset,this),i.on("click",this._executeClickListeners,this),i.on("mousemove",this._updateMouseCursor,this)},onRemove:function(i){this.options.pane?this.getPane().removeChild(this._canvas):i.getPanes().overlayPane.removeChild(this._canvas)},addTo:function(i){return i.addLayer(this),this},_drawMarker:function(i){var t=this,n=this._map.latLngToContainerPoint(i.getLatLng()),o=i.options.icon.options.iconUrl;if(this.imageCache[o])this.imageCache[o]&&this.imageCache[o].complete&&0!==this.imageCache[o].naturalWidth&&t._drawImage(i,n);else{t=this;this.imageCache[o]=new Image,this.imageCache[o].onload=function(){t._scheduleRedraw()},this.imageCache[o].src=o}},_drawImage:function(i,t){this._context.globalAlpha=i.options.opacity,i._zIndex=this._zIndex++;var n=i.options.icon.options.iconSize[0],o=i.options.icon.options.iconSize[1];t.x<2*-n||t.y<2*-o||t.x>this._canvas.width+2*n||t.y>this._canvas.height+2*o||(i.options.icon.options.iconOrigin?this._context.drawImage(this.imageCache[i.options.icon.options.iconUrl],i.options.icon.options.iconOrigin[0],i.options.icon.options.iconOrigin[1],i.options.icon.options.iconSize[0],i.options.icon.options.iconSize[1],t.x-i.options.icon.options.iconAnchor[0],t.y-i.options.icon.options.iconAnchor[1],i.options.icon.options.iconSize[0],i.options.icon.options.iconSize[1]):this._context.drawImage(this.imageCache[i.options.icon.options.iconUrl],t.x-i.options.icon.options.iconAnchor[0],t.y-i.options.icon.options.iconAnchor[1],i.options.icon.options.iconSize[0],i.options.icon.options.iconSize[1]))},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);i.DomUtil.setPosition(this._canvas,t);var n=this._map.getSize();this._canvas.width=n.x,this._canvas.height=n.y,this._redraw()},_redraw:function(i){this._frame=null,this._zIndex=0,this._map&&(i&&this._context.clearRect(0,0,this._canvas.width,this._canvas.height),this._markers&&Object.keys(this._markers).forEach(function(i){this._drawMarker(this._markers[i])},this))},_initCanvas:function(){this._canvas=i.DomUtil.create("canvas","leaflet-canvas-icon-layer leaflet-layer"),this._canvas.style.zIndex=600;var t=this._map.getSize();this._canvas.width=t.x,this._canvas.height=t.y,this._context=this._canvas.getContext("2d");var n=this._map.options.zoomAnimation&&i.Browser.any3d;if(i.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(n?"animated":"hide")),n){var o=this;map.on("zoomanim",function(i){o._animateZoom(i)})}},_updateOptions:function(){},_executeClickListeners:function(i){var t=null;for(var n in this._markers){var o=this._markers[n],e=this._map.latLngToContainerPoint(this._markers[n].getLatLng());this._hit(o,e,i)&&o.options.opacity>0&&(!t||o._zIndex>t._zIndex)&&(t=o)}t&&t.fire("click")},_updateMouseCursor:function(i){var t=!1;for(var n in this._markers){var o=this._markers[n],e=this._map.latLngToContainerPoint(this._markers[n].getLatLng());if(this._hit(o,e,i)&&o.options.opacity>0){t=!0;break}}this._map._container.style.cursor=t?"pointer":""},_hit:function(i,t,n){var o=i.options.icon.options.iconSize[0],e=i.options.icon.options.iconSize[1],s=i.options.icon.options.iconAnchor[0],a=i.options.icon.options.iconAnchor[1],r=n.containerPoint.x,c=n.containerPoint.y;return r>=t.x-s&&r<=t.x-s+o&&c>=t.y-a&&c<=t.y-a+e},_setTransform:function(t,n,o){var e=n||new i.Point(0,0);t.style[i.DomUtil.TRANSFORM]=(i.Browser.ie3d?"translate("+e.x+"px,"+e.y+"px)":"translate3d("+e.x+"px,"+e.y+"px,0)")+(o?" scale("+o+")":"")},_animateZoom:function(t){var n=this._map.getZoomScale(t.zoom),o=i.Layer?this._map._latLngBoundsToNewLayerBounds(this._map.getBounds(),t.zoom,t.center).min:this._map._getCenterOffset(t.center)._multiplyBy(-n).subtract(this._map._getMapPanePos());i.DomUtil.setTransform(this._canvas,o,n)}});i.canvasIconLayer=function(i){return new t(i)}},window);